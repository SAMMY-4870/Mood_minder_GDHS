{% extends 'base.html' %}
{% block title %}Health Chatbot Â· Mental Health App{% endblock %}
{% block extra_css %}
<link href="{{ url_for('static', filename='css/pages/games.css') }}" rel="stylesheet">
<style>
.chatbot-container {
    max-width: 900px;
    margin: 0 auto;
    height: 80vh;
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    overflow: hidden;
}

.chatbot-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    text-align: center;
}

.chatbot-header h1 {
    margin: 0;
    font-size: 1.8rem;
}

.chatbot-header p {
    margin: 5px 0 0 0;
    opacity: 0.9;
    font-size: 0.9rem;
}

.chatbot-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message {
    max-width: 70%;
    padding: 15px 20px;
    border-radius: 20px;
    word-wrap: break-word;
    animation: messageSlide 0.3s ease;
}

@keyframes messageSlide {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.user {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 5px;
}

.message.bot {
    background: white;
    color: #333;
    align-self: flex-start;
    border-bottom-left-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-left: 4px solid #667eea;
}

.message-time {
    font-size: 0.7rem;
    opacity: 0.7;
    margin-top: 5px;
}

.chatbot-input {
    padding: 20px;
    background: white;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 10px;
    align-items: center;
}

.chatbot-input input {
    flex: 1;
    padding: 12px 20px;
    border: 2px solid #e9ecef;
    border-radius: 25px;
    outline: none;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.chatbot-input input:focus {
    border-color: #667eea;
}

.chatbot-input button {
    padding: 12px 25px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.chatbot-input button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(111, 66, 193, 0.3);
}

.chatbot-input button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.quick-responses {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    max-height: 120px;
    overflow-y: auto;
}

.quick-response-btn {
    padding: 8px 15px;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    color: #555;
}

.quick-response-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
    transform: translateY(-1px);
}

.typing-indicator {
    display: none;
    align-self: flex-start;
    background: white;
    padding: 15px 20px;
    border-radius: 20px;
    border-bottom-left-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-left: 4px solid #667eea;
}

.typing-dots {
    display: flex;
    gap: 4px;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: #667eea;
    border-radius: 50%;
    animation: typingDot 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typingDot {
    0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

.chatbot-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.feature-card {
    background: white;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.feature-card:hover {
    transform: translateY(-5px);
}

.feature-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
}

.feature-title {
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
}

.feature-description {
    color: #666;
    font-size: 0.9rem;
    line-height: 1.4;
}

.resources-section {
    background: #e3f2fd;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
}

.resources-section h3 {
    color: #1976d2;
    margin-bottom: 20px;
    font-size: 1.3rem;
}

.resource-item {
    background: white;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 10px;
    border-left: 4px solid #1976d2;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.resource-item a {
    color: #1976d2;
    text-decoration: none;
    font-weight: 500;
}

.resource-item a:hover {
    text-decoration: underline;
}

.chatbot-stats {
    display: flex;
    justify-content: space-around;
    background: white;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 5px;
}

.stat-label {
    color: #666;
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .chatbot-container {
        height: 90vh;
        margin: 10px;
    }
    
    .message {
        max-width: 85%;
    }
    
    .quick-responses {
        max-height: 100px;
    }
    
    .chatbot-features {
        grid-template-columns: 1fr;
    }
    
    .chatbot-stats {
        flex-direction: column;
        gap: 15px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="chatbot-container">
    <div class="chatbot-header">
        <h1>ðŸ¤– Health Assistant</h1>
        <p>Your AI-powered mental health companion</p>
    </div>
    
    <div class="chatbot-messages" id="chatbotMessages">
        <div class="message bot">
            <div>Hello! I'm your mental health assistant. I'm here to listen, provide support, and help you with any questions about mental health and well-being. How are you feeling today?</div>
            <div class="message-time" id="welcomeTime"></div>
        </div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    </div>
    
    <div class="quick-responses" id="quickResponses">
        <button class="quick-response-btn" onclick="sendQuickResponse('How are you feeling today?')">How are you feeling?</button>
        <button class="quick-response-btn" onclick="sendQuickResponse('I need help with anxiety')">Help with anxiety</button>
        <button class="quick-response-btn" onclick="sendQuickResponse('I feel stressed')">I feel stressed</button>
        <button class="quick-response-btn" onclick="sendQuickResponse('Sleep problems')">Sleep problems</button>
        <button class="quick-response-btn" onclick="sendQuickResponse('Feeling depressed')">Feeling depressed</button>
        <button class="quick-response-btn" onclick="sendQuickResponse('Fitness tips')">Fitness tips</button>
        <button class="quick-response-btn" onclick="sendQuickResponse('Nutrition advice')">Nutrition advice</button>
        <button class="quick-response-btn" onclick="sendQuickResponse('Health tips')">Health tips</button>
        <button class="quick-response-btn" onclick="sendQuickResponse('Coping strategies')">Coping strategies</button>
    </div>
    
    <div class="chatbot-input">
        <input type="text" id="messageInput" placeholder="Type your message here..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()" id="sendButton">Send</button>
    </div>
</div>

<!-- Features Section -->
<div class="chatbot-features">
    <div class="feature-card">
        <div class="feature-icon">ðŸ’¬</div>
        <div class="feature-title">24/7 Support</div>
        <div class="feature-description">Available anytime you need someone to talk to</div>
    </div>
    <div class="feature-card">
        <div class="feature-icon">ðŸ§ </div>
        <div class="feature-title">AI-Powered</div>
        <div class="feature-description">Advanced AI trained on mental health best practices</div>
    </div>
    <div class="feature-card">
        <div class="feature-icon">ðŸ”’</div>
        <div class="feature-title">Private & Secure</div>
        <div class="feature-description">Your conversations are confidential and secure</div>
    </div>
    <div class="feature-card">
        <div class="feature-icon">ðŸ“š</div>
        <div class="feature-title">Expert Knowledge</div>
        <div class="feature-description">Access to evidence-based mental health information</div>
    </div>
</div>

<!-- Resources Section -->
<div class="resources-section">
    <h3>ðŸ†˜ Crisis Resources</h3>
    <div class="resource-item">
        <strong>National Suicide Prevention Lifeline:</strong> <a href="tel:988">988</a>
    </div>
    <div class="resource-item">
        <strong>Crisis Text Line:</strong> <a href="sms:741741">Text HOME to 741741</a>
    </div>
    <div class="resource-item">
        <strong>National Alliance on Mental Illness:</strong> <a href="tel:1-800-950-NAMI">1-800-950-NAMI</a>
    </div>
    <div class="resource-item">
        <strong>Mental Health America:</strong> <a href="https://www.mhanational.org" target="_blank">www.mhanational.org</a>
    </div>
</div>

<!-- Chatbot Stats -->
<div class="chatbot-stats">
    <div class="stat-item">
        <div class="stat-value" id="messagesCount">0</div>
        <div class="stat-label">Messages</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="sessionTime">0m</div>
        <div class="stat-label">Session Time</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="responseTime">0s</div>
        <div class="stat-label">Avg Response</div>
    </div>
</div>

<script>
let messageCount = 0;
let sessionStartTime = Date.now();
let responseTimes = [];

// Set welcome time
document.getElementById('welcomeTime').textContent = new Date().toLocaleTimeString();

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (message === '') return;
    
    // Add user message
    addMessage(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send to server
    const startTime = Date.now();
    fetch('/api/chatbot', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            conversation_id: getConversationId()
        })
    })
    .then(response => response.json())
    .then(data => {
        const responseTime = Date.now() - startTime;
        responseTimes.push(responseTime);
        
        // Hide typing indicator
        hideTypingIndicator();
        
        // Add bot response
        if (data.success) {
            addMessage(data.response, 'bot');
        } else {
            addMessage('I apologize, but I\'m having trouble processing your message right now. Please try again.', 'bot');
        }
        
        // Update stats
        updateStats();
        
        // Update quick responses
        updateQuickResponses(data.quick_responses);
    })
    .catch(error => {
        console.error('Error:', error);
        hideTypingIndicator();
        addMessage('I\'m sorry, I\'m experiencing technical difficulties. Please try again in a moment.', 'bot');
    });
}

function sendQuickResponse(message) {
    document.getElementById('messageInput').value = message;
    sendMessage();
}

function addMessage(text, sender) {
    const messagesContainer = document.getElementById('chatbotMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const time = new Date().toLocaleTimeString();
    messageDiv.innerHTML = `
        <div>${text}</div>
        <div class="message-time">${time}</div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    if (sender === 'user') {
        messageCount++;
    }
}

function showTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'block';
    document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'none';
}

function updateStats() {
    document.getElementById('messagesCount').textContent = messageCount;
    
    const sessionTime = Math.floor((Date.now() - sessionStartTime) / 60000);
    document.getElementById('sessionTime').textContent = `${sessionTime}m`;
    
    if (responseTimes.length > 0) {
        const avgResponseTime = Math.round(responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length / 1000);
        document.getElementById('responseTime').textContent = `${avgResponseTime}s`;
    }
}

function updateQuickResponses(quickResponses) {
    if (quickResponses && quickResponses.length > 0) {
        const quickResponsesContainer = document.getElementById('quickResponses');
        quickResponsesContainer.innerHTML = '';
        
        quickResponses.forEach(response => {
            const button = document.createElement('button');
            button.className = 'quick-response-btn';
            button.textContent = response;
            button.onclick = () => sendQuickResponse(response);
            quickResponsesContainer.appendChild(button);
        });
    }
}

function getConversationId() {
    let conversationId = sessionStorage.getItem('conversationId');
    if (!conversationId) {
        conversationId = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('conversationId', conversationId);
    }
    return conversationId;
}

// Auto-focus input
document.getElementById('messageInput').focus();

// Update session time every minute
setInterval(() => {
    const sessionTime = Math.floor((Date.now() - sessionStartTime) / 60000);
    document.getElementById('sessionTime').textContent = `${sessionTime}m`;
}, 60000);
</script>
{% endblock %}
